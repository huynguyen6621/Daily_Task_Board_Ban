<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn n·ªôi b·ªô nh√≥m</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px -10px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" opacity="0.1"><polygon points="1000,100 1000,0 0,100" fill="white"/></svg>');
            background-size: cover;
        }

        .card-enhanced {
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card-enhanced:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .task-input-container {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .task-input {
            border: none;
            resize: none;
            font-size: 1.1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }

        .task-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px #667eea;
        }

        .action-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: #4a5568;
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .post-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .dropdown {
            position: absolute;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
            z-index: 10;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }

        .dropdown-item:hover {
            background: #f8fafc;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .table-header th {
            color: white;
            font-weight: 600;
            padding: 16px 20px;
            border: none;
        }

        .task-row {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .task-row:hover {
            background-color: #f8fafc;
            border-left: 4px solid #667eea;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .pulse-loading {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>

<body class="p-4 sm:p-8">

    <!-- Header v·ªõi Background v√† Logo -->
    <header class="mb-8 header-custom p-8 rounded-2xl">
        <div class="max-w-7xl mx-auto relative z-10">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='40' fill='%23ffffff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='14' fill='%23667eea'%3ELOGO%3C/text%3E%3C/svg%3E" 
                         alt="Team Logo" class="logo">
                    <div>
                        <p class="text-white/90 text-lg">Ban X√¢y D·ª±ng ƒê·∫£ng - ƒê·∫£ng u·ª∑ ph∆∞·ªùng H·∫£i Ch√¢u</p>
                        <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2">
                            B·∫£ng c√¥ng vi·ªác n·ªôi b·ªô
                        </h1>
                    </div>
                </div>
            </div>
            <p class="text-white/80 mb-6 text-lg">N∆°i t·∫≠p trung th√¥ng tin v√† ƒëi·ªÅu h√†nh c√¥ng vi·ªác h√†ng ng√†y c·ªßa Ban</p>
            <div id="user-info" class="text-white font-medium p-3 bg-white/20 rounded-xl border border-white/30 backdrop-blur-sm">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-3 pulse-loading"></div>
                    ƒêang k·∫øt n·ªëi h·ªá th·ªëng...
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- C·ªòT 1: TH√îNG B√ÅO & LI√äN K·∫æT NHANH -->
        <div class="lg:col-span-1 space-y-8">
            <!-- Th·∫ª Th√¥ng b√°o quan tr·ªçng -->
            <div class="card-enhanced p-6 border-l-4 border-red-500">
                <h2 class="text-xl font-bold mb-4 flex items-center text-red-600">
                    <i class="fas fa-exclamation-triangle mr-3"></i>
                    Th√¥ng b√°o quan tr·ªçng!
                </h2>
                <ul id="important-announcements" class="space-y-4">
                    <li class="p-4 bg-red-50 rounded-xl border border-red-200 transform transition hover:scale-[1.02]">
                        <span class="font-semibold text-red-700">üìÖ H·∫°n ch√≥t:</span> N·ªôp b√°o c√°o nƒÉm tr∆∞·ªõc 17:00 ng√†y 05/12.
                    </li>
                    <li class="p-4 bg-red-50 rounded-xl border border-red-200 transform transition hover:scale-[1.02]">
                        <span class="font-semibold text-red-700">üë• H·ªçp Kh·∫©n:</span> Chi·ªÅu nay l√∫c 14:00 t·∫°i Ph√≤ng h·ªçp Ban.
                    </li>
                </ul>
            </div>
            
            <!-- Th·∫ª Ho·∫°t ƒë·ªông phong tr√†o -->
            <div class="card-enhanced p-6 border-l-4 border-blue-500">
                <h2 class="text-xl font-bold mb-4 flex items-center text-blue-600">
                    <i class="fas fa-calendar-alt mr-3"></i>
                    Ho·∫°t ƒë·ªông phong tr√†o
                </h2>
                <ul id="activity-announcements" class="space-y-4">
                    <li class="p-4 bg-blue-50 rounded-xl border border-blue-200 transform transition hover:scale-[1.02]">
                        <span class="font-semibold text-blue-700">‚òï Ch√∫ √Ω:</span> S√°ng mai, tr∆∞·ªüng ban m·ªùi c√† ph√™.
                    </li>
                    <li class="p-4 bg-blue-50 rounded-xl border border-blue-200 transform transition hover:scale-[1.02]">
                        <span class="font-semibold text-blue-700">üéÇ L∆∞u √Ω:</span> Tu·∫ßn n√†y c√≥ sinh nh·∫≠t S·∫øp.
                    </li>
                </ul>
            </div>
            
            <!-- Th·∫ª Li√™n k·∫øt nhanh -->
            <div class="card-enhanced p-6 border-l-4 border-green-500">
                <h2 class="text-xl font-bold mb-4 flex items-center text-green-600">
                    <i class="fas fa-link mr-3"></i>
                    T√†i nguy√™n & Li√™n k·∫øt
                </h2>
                <ul class="space-y-3">
                    <li class="border-b border-gray-200 pb-3 transition hover:translate-x-2">
                        <a href="#" class="text-gray-700 hover:text-green-600 transition duration-300 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
                            Google Drive Chung
                        </a>
                    </li>
                    <li class="border-b border-gray-200 pb-3 transition hover:translate-x-2">
                        <a href="#" class="text-gray-700 hover:text-green-600 transition duration-300 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
                            T√†i li·ªáu H∆∞·ªõng d·∫´n Quy tr√¨nh
                        </a>
                    </li>
                    <li class="border-b border-gray-200 pb-3 transition hover:translate-x-2">
                        <a href="#" class="text-gray-700 hover:text-green-600 transition duration-300 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
                            Danh b·∫° n·ªôi b·ªô
                        </a>
                    </li>
                    <li class="transition hover:translate-x-2">
                        <a href="#" class="text-gray-700 hover:text-green-600 transition duration-300 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
                            H·ªá th·ªëng Y√™u c·∫ßu H·ªó tr·ª£ (IT)
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- C·ªôt 2: C√¥ng vi·ªác (2 khung ri√™ng bi·ªát) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- KHUNG TR√äN: T·∫°o c√¥ng vi·ªác ki·ªÉu Facebook -->
            <div class="card-enhanced p-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800">
                    <i class="fas fa-plus-circle mr-3 text-indigo-600"></i>
                    Th√™m c√¥ng vi·ªác m·ªõi
                </h2>
                
                <div class="task-input-container">
                    <div class="flex items-start space-x-3 mb-4">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3E%3Ccircle cx='25' cy='25' r='25' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='white'%3EYB%3C/text%3E%3C/svg%3E" 
                             alt="User Avatar" class="avatar">
                        <textarea 
                            id="quick-task-input" 
                            class="task-input w-full" 
                            rows="2" 
                            placeholder="Th√™m c√¥ng vi·ªác m·ªõi..."
                        ></textarea>
                    </div>
                    
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <div class="flex flex-wrap gap-2">
                            <div class="relative">
                                <button id="assignee-btn" class="action-btn flex items-center">
                                    <i class="fas fa-user mr-2"></i>
                                    <span id="assignee-text">Ng∆∞·ªùi ph·ª• tr√°ch</span>
                                </button>
                                <div id="assignee-dropdown" class="dropdown hidden mt-2">
                                    <div class="dropdown-item" data-value="Nguy·ªÖn VƒÉn A">Nguy·ªÖn VƒÉn A</div>
                                    <div class="dropdown-item" data-value="Tr·∫ßn Th·ªã B">Tr·∫ßn Th·ªã B</div>
                                    <div class="dropdown-item" data-value="L√™ VƒÉn C">L√™ VƒÉn C</div>
                                    <div class="dropdown-item" data-value="Ph·∫°m Th·ªã D">Ph·∫°m Th·ªã D</div>
                                </div>
                            </div>
                            
                            <div class="relative">
                                <button id="deadline-btn" class="action-btn flex items-center">
                                    <i class="fas fa-calendar mr-2"></i>
                                    <span id="deadline-text">Th·ªùi h·∫°n</span>
                                </button>
                                <div id="deadline-dropdown" class="dropdown hidden mt-2 p-4">
                                    <input type="date" id="deadline-picker" class="w-full p-2 border rounded">
                                </div>
                            </div>
                            
                            <div class="relative">
                                <button id="status-btn" class="action-btn flex items-center">
                                    <i class="fas fa-flag mr-2"></i>
                                    <span id="status-text">Tr·∫°ng th√°i</span>
                                </button>
                                <div id="status-dropdown" class="dropdown hidden mt-2">
                                    <div class="dropdown-item" data-value="Ch∆∞a b·∫Øt ƒë·∫ßu">Ch∆∞a b·∫Øt ƒë·∫ßu</div>
                                    <div class="dropdown-item" data-value="ƒêang ti·∫øn h√†nh">ƒêang ti·∫øn h√†nh</div>
                                    <div class="dropdown-item" data-value="Ho√†n th√†nh">Ho√†n th√†nh</div>
                                    <div class="dropdown-item" data-value="Tr·ªÖ h·∫°n">Tr·ªÖ h·∫°n</div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="quick-add-btn" class="post-btn flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Th√™m
                        </button>
                    </div>
                </div>
            </div>

            <!-- KHUNG D∆Ø·ªöI: Danh s√°ch c√¥ng vi·ªác -->
            <div class="card-enhanced p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-tasks mr-3 text-indigo-600"></i>
                        Danh s√°ch c√¥ng vi·ªác
                    </h2>
                    <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
                        <span id="task-count">0</span> c√¥ng vi·ªác
                    </span>
                </div>

                <!-- B·∫£ng C√¥ng vi·ªác -->
                <div class="overflow-hidden rounded-2xl border border-gray-200">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="text-left">C√¥ng vi·ªác/D·ª± √°n</th>
                                <th class="text-left">Ng∆∞·ªùi Ph·ª• tr√°ch</th>
                                <th class="text-left">H·∫°n ch√≥t</th>
                                <th class="text-left">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="task-table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                    <div class="flex justify-center items-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-3"></div>
                                        ƒêang t·∫£i d·ªØ li·ªáu...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal C·∫≠p nh·∫≠t Tr·∫°ng th√°i -->
    <div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 modal-enter">
            <h3 class="text-2xl font-bold mb-2 text-indigo-700">C·∫≠p nh·∫≠t Tr·∫°ng th√°i C√¥ng vi·ªác</h3>
            <p id="status-task-name" class="text-gray-700 mb-6 italic"></p>

            <label for="status-select" class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn tr·∫°ng th√°i m·ªõi:</label>
            <select id="status-select" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg rounded-md border-2">
                <option value="ƒêang ti·∫øn h√†nh">ƒêang ti·∫øn h√†nh</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                <option value="Tr·ªÖ h·∫°n">Tr·ªÖ h·∫°n</option>
                <option value="Ch∆∞a b·∫Øt ƒë·∫ßu">Ch∆∞a b·∫Øt ƒë·∫ßu</option>
            </select>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="status-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">H·ªßy</button>
                <button id="status-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- Modal th√¥ng b√°o -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-gray-800">Th√¥ng b√°o</h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script>
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyAeL284r7CxG5w1pIusYGCXqU_bFGTTzhI",
            authDomain: "caramel-slice-474305-s2.firebaseapp.com",
            projectId: "caramel-slice-474305-s2",
            storageBucket: "caramel-slice-474305-s2.firebasestorage.app",
            messagingSenderId: "931447399209",
            appId: "1:931447399209:web:b6b8809d36dc5f31868d38",
            measurementId: "G-LRQWPB3X4C"
        });
    
        const __app_id = "daily-task-board";
        const __initial_auth_token = null;
    </script>

    <!-- Script Module cho Firebase v√† Logic ·ª®ng d·ª•ng -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // B·∫≠t log debug cho Firestore
        setLogLevel('Debug');

        // Khai b√°o c√°c bi·∫øn Firebase to√†n c·ª•c
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Kh·ªüi t·∫°o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Bi·∫øn ·ª©ng d·ª•ng
        let userId = null;
        let tasks = []; 
        let currentTaskId = null;
        let isAuthReady = false;
        let isInitializing = false;

        // ƒê·ªãnh nghƒ©a ƒë∆∞·ªùng d·∫´n collection
        const TASK_COLLECTION_PATH = `artifacts/${appId}/public/data/tasks`;

        // D·ªØ li·ªáu m·∫´u ban ƒë·∫ßu
        const initialTasks = [
            { name: "Ho√†n thi·ªán h·ª£p ƒë·ªìng ƒë·ªëi t√°c A", assignee: "Nguy·ªÖn VƒÉn A", deadline: "2025-11-05", status: "ƒêang ti·∫øn h√†nh" },
            { name: "L√™n k·∫ø ho·∫°ch Marketing Q4", assignee: "Tr·∫ßn Th·ªã B", deadline: "2025-11-20", status: "Ho√†n th√†nh" },
            { name: "Thi·∫øt k·∫ø l·∫°i giao di·ªán h·ªá th·ªëng n·ªôi b·ªô", assignee: "L√™ VƒÉn C", deadline: "2025-12-15", status: "Tr·ªÖ h·∫°n" },
            { name: "Ki·ªÉm tra ng√¢n s√°ch qu√Ω cu·ªëi", assignee: "Ph·∫°m Th·ªã D", deadline: "2025-11-10", status: "Ch∆∞a b·∫Øt ƒë·∫ßu" },
        ];

        // ===============================================
        // DOM Elements - PH·∫¶N M·ªöI
        // ===============================================
        // Quick Task Input
        const quickTaskInput = document.getElementById('quick-task-input');
        const quickAddBtn = document.getElementById('quick-add-btn');
        
        // Dropdown buttons
        const assigneeBtn = document.getElementById('assignee-btn');
        const deadlineBtn = document.getElementById('deadline-btn');
        const statusBtn = document.getElementById('status-btn');
        
        // Dropdown menus
        const assigneeDropdown = document.getElementById('assignee-dropdown');
        const deadlineDropdown = document.getElementById('deadline-dropdown');
        const statusDropdown = document.getElementById('status-dropdown');
        
        // Dropdown text displays
        const assigneeText = document.getElementById('assignee-text');
        const deadlineText = document.getElementById('deadline-text');
        const statusText = document.getElementById('status-text');
        
        // Date picker
        const deadlinePicker = document.getElementById('deadline-picker');

        // Selected values
        let selectedAssignee = null;
        let selectedDeadline = null;
        let selectedStatus = "Ch∆∞a b·∫Øt ƒë·∫ßu";

        // ===============================================
        // QUICK TASK FUNCTIONALITY - PH·∫¶N ƒê√É S·ª¨A
        // ===============================================
        
        // Dropdown toggle functions - ƒê√É S·ª¨A L·ªñI
        function toggleDropdown(dropdown, btn) {
            const allDropdowns = [assigneeDropdown, deadlineDropdown, statusDropdown];
            allDropdowns.forEach(dd => {
                if (dd !== dropdown) dd.classList.add('hidden');
            });
            
            if (dropdown.classList.contains('hidden')) {
                const rect = btn.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                dropdown.style.zIndex = '1000';
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Event listeners for dropdown buttons
        assigneeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(assigneeDropdown, assigneeBtn);
        });

        deadlineBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(deadlineDropdown, deadlineBtn);
            // Set today as default
            const today = new Date().toISOString().split('T')[0];
            deadlinePicker.value = today;
        });

        statusBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(statusDropdown, statusBtn);
        });

        // Handle dropdown item clicks
        assigneeDropdown.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                selectedAssignee = item.getAttribute('data-value');
                assigneeText.textContent = selectedAssignee;
                assigneeDropdown.classList.add('hidden');
            });
        });

        statusDropdown.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                selectedStatus = item.getAttribute('data-value');
                statusText.textContent = selectedStatus;
                statusDropdown.classList.add('hidden');
            });
        });

        // Handle date selection
        deadlinePicker.addEventListener('change', () => {
            selectedDeadline = deadlinePicker.value;
            const date = new Date(selectedDeadline);
            deadlineText.textContent = date.toLocaleDateString('vi-VN');
            deadlineDropdown.classList.add('hidden');
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            [assigneeDropdown, deadlineDropdown, statusDropdown].forEach(dd => {
                dd.classList.add('hidden');
            });
        });

        // Quick add task functionality
        quickAddBtn.addEventListener('click', addQuickTask);
        quickTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addQuickTask();
            }
        });

        async function addQuickTask() {
            const taskName = quickTaskInput.value.trim();
            
            if (!taskName) {
                showModal("L·ªói", "Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác");
                return;
            }
            
            if (!selectedAssignee) {
                showModal("L·ªói", "Vui l√≤ng ch·ªçn ng∆∞·ªùi ph·ª• tr√°ch");
                return;
            }
            
            if (!selectedDeadline) {
                showModal("L·ªói", "Vui l√≤ng ch·ªçn th·ªùi h·∫°n");
                return;
            }

            if (!userId) {
                showModal("L·ªói Quy·ªÅn truy c·∫≠p", "Vui l√≤ng ƒë·ª£i qu√° tr√¨nh x√°c th·ª±c ho√†n t·∫•t");
                return;
            }

            const newTask = {
                name: taskName,
                assignee: selectedAssignee,
                deadline: selectedDeadline,
                status: selectedStatus,
            };

            try {
                const tasksCollection = collection(db, TASK_COLLECTION_PATH);
                await addDoc(tasksCollection, newTask);
                
                // Reset form
                quickTaskInput.value = '';
                selectedAssignee = null;
                selectedDeadline = null;
                selectedStatus = "Ch∆∞a b·∫Øt ƒë·∫ßu";
                assigneeText.textContent = "Ng∆∞·ªùi ph·ª• tr√°ch";
                deadlineText.textContent = "Th·ªùi h·∫°n";
                statusText.textContent = "Tr·∫°ng th√°i";
                
                showModal("Th√†nh c√¥ng!", `ƒê√£ th√™m c√¥ng vi·ªác: "${taskName}"`);

            } catch (error) {
                console.error("Firestore Add Error:", error);
                showModal("L·ªói L∆∞u tr·ªØ", "Kh√¥ng th·ªÉ th√™m c√¥ng vi·ªác m·ªõi");
            }
        }

        // ===============================================
        // PH·∫¶N C√íN L·∫†I C·ª¶A ·ª®NG D·ª§NG
        // ===============================================
        
        // C√°c DOM elements c≈©
        const taskTableBody = document.getElementById('task-table-body');
        const userInfoDiv = document.getElementById('user-info');
        
        // Modal elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const statusModal = document.getElementById('status-modal');
        const statusSelect = document.getElementById('status-select');
        const statusSaveBtn = document.getElementById('status-save-btn');
        const statusCancelBtn = document.getElementById('status-cancel-btn');

        // Auth & Firestore functions
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                await signInAnonymously(auth);
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userInfoDiv.textContent = `ƒê√£ ƒëƒÉng nh·∫≠p | User ID: ${userId}`;
                isAuthReady = true;
                setTimeout(listenToTasks, 500); 
            } else {
                isAuthReady = true;
                userInfoDiv.textContent = `L·ªói x√°c th·ª±c: Kh√¥ng th·ªÉ truy c·∫≠p d·ªØ li·ªáu. Vui l√≤ng th·ª≠ t·∫£i l·∫°i.`;
                console.error("Authentication failed or user is not logged in. Cannot access Firestore.");
            }
        });

        function listenToTasks() {
            if (!userId || !isAuthReady) return;

            const tasksCollection = collection(db, TASK_COLLECTION_PATH);
            
            onSnapshot(tasksCollection, (snapshot) => {
                if (snapshot.empty && !localStorage.getItem('tasksInitialized') && !isInitializing) {
                    initializeInitialTasks();
                    localStorage.setItem('tasksInitialized', 'true');
                } 				

                tasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                tasks.sort((a, b) => a.id.localeCompare(b.id));
                renderTasks();

            }, (error) => {
                console.error("Firestore Listen Error:", error);
                showModal("L·ªói D·ªØ li·ªáu", "Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c truy xu·∫•t d·ªØ li·ªáu t·ª´ Firestore.");
            });
        }

        async function initializeInitialTasks() {
            if (isInitializing) return;
            isInitializing = true;
            
            console.log("Collection tr·ªëng, t·∫°o d·ªØ li·ªáu m·∫´u.");
            try {
                const tasksCollection = collection(db, TASK_COLLECTION_PATH);
                for (const task of initialTasks) {
                    await addDoc(tasksCollection, task);
                }
            } catch (error) {
                 console.error("Error writing initial document: ", error);
            } finally {
                isInitializing = false;  
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Ho√†n th√†nh': return 'bg-green-100 text-green-800';
                case 'ƒêang ti·∫øn h√†nh': return 'bg-yellow-100 text-yellow-800';
                case 'Tr·ªÖ h·∫°n': return 'bg-red-100 text-red-800';
                case 'Ch∆∞a b·∫Øt ƒë·∫ßu': return 'bg-gray-100 text-gray-600';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function renderTasks() {
            taskTableBody.innerHTML = '';
            document.getElementById('task-count').textContent = tasks.length;
            
            if (tasks.length === 0 && isAuthReady) {
                 taskTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o.</td></tr>';
                 return;
            }

            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'task-row';
                row.dataset.taskId = task.id;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${task.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-gray-700">${task.assignee}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-gray-700">${task.deadline}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(task.status)}">${task.status}</span>
                    </td>
                `;
                
                row.addEventListener('click', () => {
                    currentTaskId = task.id;
                    document.getElementById('status-task-name').textContent = task.name;
                    statusSelect.value = task.status;
                    statusModal.classList.remove('hidden');
                });
                
                taskTableBody.appendChild(row);
            });
        }

        // Status Modal Handlers
        statusSaveBtn.addEventListener('click', async () => {
            if (!currentTaskId) return;
            
            const newStatus = statusSelect.value;
            try {
                const taskDocRef = doc(db, TASK_COLLECTION_PATH, currentTaskId);
                await setDoc(taskDocRef, { status: newStatus }, { merge: true });
                statusModal.classList.add('hidden');
                showModal("Th√†nh c√¥ng!", `ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác th√†nh: ${newStatus}`);
            } catch (error) {
                console.error("Firestore Update Error:", error);
                showModal("L·ªói C·∫≠p nh·∫≠t", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác");
            }
        });

        statusCancelBtn.addEventListener('click', () => {
            statusModal.classList.add('hidden');
        });

        // Modal Handlers
        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
        });

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
        }

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        authenticateUser();
    </script>
</body>
</html>